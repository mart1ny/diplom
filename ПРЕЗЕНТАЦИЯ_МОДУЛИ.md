# Описание модулей проекта

## Основные модули (scripts/)

### 1. `inference.py` — Главный пайплайн обработки видео
**Что делает:**
- Загружает YOLOv8 модель для детекции автомобилей
- Обрабатывает видео/RTSP-поток кадр за кадром
- Координирует работу всех модулей: детекция → трекинг → анализ траекторий → подсчёт очередей → анализ риска → оптимизация фаз
- Выводит результаты: аннотированное видео, логи очередей, near-miss события, рекомендации по фазам светофора

**Ключевые функции:**
- `process_video()` — основной цикл обработки
- Интеграция всех компонентов системы

---

### 2. `tracking.py` — Трекинг объектов (Kalman Filter)
**Что делает:**
- Отслеживает автомобили между кадрами, присваивая стабильные ID
- Использует фильтр Калмана для предсказания позиций
- Выполняет ассоциацию детекций с существующими треками (жадный алгоритм по расстоянию)
- Удаляет "мёртвые" треки (объекты, которые пропали на N кадров)

**Классы:**
- `TrackState` — хранит состояние трека (ID, попадания, пропуски, возраст)
- `SimpleKalmanTracker` — основной трекер с методами `update()`, `step()`, `predict()`

**Результат:** Словарь `{track_id: (x, y)}` — позиции всех отслеживаемых машин

---

### 3. `queue_counter.py` — Подсчёт очередей по ROI
**Что делает:**
- Определяет, сколько машин находится в очередях на каждом подходе (north/south/east/west)
- Использует полигоны ROI (Region of Interest) для каждого подхода
- Считает машину частью очереди, только если она находится в ROI несколько кадров подряд (фильтр шума)

**Классы:**
- `QueueCounter` — основной класс подсчёта
- `load_roi_config()` — загрузка ROI из JSON или использование дефолтных

**Результат:** Словарь `{approach: queue_length}` — длина очереди по каждому направлению

---

### 4. `rajectory_analysis.py` — Анализ траекторий и оценка риска
**Что делает:**
- Сохраняет историю движения каждого трека (координаты по кадрам)
- Вычисляет скорости и направления движения
- Находит пары машин, которые могут столкнуться (близкое расстояние)
- Рассчитывает метрики риска: **TTC (Time To Collision)** и **PET (Post-Encroachment Time)**
- Выявляет события "near-miss" (почти-аварии) на основе порогов риска

**Классы:**
- `TrajectoryAnalyzer` — хранение траекторий, вычисление скоростей/направлений
- `RiskAnalyzer` — анализ риска на основе TTC/PET
- `RiskLSTMModel` — опциональная LSTM-модель для более точной оценки риска

**Результат:** Список событий near-miss с метриками (TTC, PET, risk_score)

---

### 5. `traffic_optimizer.py` — LP-оптимизация фаз светофора
**Что делает:**
- Решает задачу линейного программирования для распределения времени зелёного сигнала
- Минимизирует: остаток очередей + штраф за риск (near-miss)
- Учитывает ограничения: min/max зелёного времени, границы длины цикла, насыщенные потоки
- Использует библиотеку `cvxpy` для решения оптимизационной задачи

**Классы:**
- `PhaseOptimizer` — оптимизатор с методом `optimize(queues, risks)`

**Результат:** План фаз светофора:
- Доли зелёного времени по каждому подходу
- Рекомендуемая длина цикла
- Ожидаемый остаток очередей после оптимизации

---

## Модули LSTM (lstm/)

### 6. `lstm/demand_forecaster.py` — LSTM-модель для прогноза загрузки
**Что делает:**
- Определяет архитектуру LSTM-сети для прогнозирования очередей на несколько шагов вперёд
- Формирует датасет из временных рядов (история очередей + календарные признаки)
- Кодирует признаки: день недели, час, погода

**Классы:**
- `TrafficDemandDataset` — PyTorch Dataset для обучения
- `TrafficDemandLSTM` — LSTM-модель (последовательность → прогноз очередей)

**Цель:** Предсказывать загрузку на основе исторических паттернов (например, "в 8 утра всегда пробка на севере")

---

### 7. `lstm/train_demand_forecaster.py` — Обучение LSTM-модели
**Что делает:**
- Загружает данные из JSONL-лога очередей
- Разделяет на train/validation
- Обучает LSTM-модель с помощью PyTorch
- Сохраняет лучшие веса модели

**Использование:**
```bash
python lstm/train_demand_forecaster.py --data lstm/queues_sample.jsonl --epochs 50
```

---

### 8. `lstm/queues_sample.jsonl` — Образец формата данных
**Что содержит:**
- Примеры записей очередей с временными метками
- Формат: `{timestamp, light_id, approach, queue_len, risk, day_of_week, hour, weather}`

**Назначение:** Шаблон для сбора реальных данных с камер

---

## Вспомогательные файлы

### `requirements.txt` — Зависимости проекта
- `ultralytics` — YOLOv8
- `opencv-python` — обработка видео
- `cvxpy` — линейное программирование
- `torch` — PyTorch для LSTM
- `numpy`, `pandas` — обработка данных

### `progress.md` — История изменений
- Фиксирует все ключевые улучшения проекта

### `README.md` — Документация проекта
- Описание системы, установка, использование

---

## Как работает система (поток данных)

```
Видео/RTSP
    ↓
[inference.py] → YOLOv8 детекция машин
    ↓
[tracking.py] → Трекинг (стабильные ID)
    ↓
[queue_counter.py] → Подсчёт очередей по ROI
    ↓
[rajectory_analysis.py] → Анализ риска (TTC/PET, near-miss)
    ↓
[traffic_optimizer.py] → LP-оптимизация фаз
    ↓
Рекомендации: {greens: {...}, cycle: 60.0}
```

**В будущем:** LSTM будет предсказывать загрузку заранее, оптимизатор будет учитывать прогноз.

